{% extends 'basis/basis_admin.html' %}

{% block link %}
<link rel="stylesheet" href="/static/css/edit_menu.css">
{% endblock %}

{% block main %}
<main>
    <h1 class="title">Редактировать меню</h1>
    <input type="search" class="menu_search" placeholder="Поиск товаров">
    <div class="edit-menu">
        {% for category, items in categories %}
        <details class="category-details">
            <summary>{{ category }}</summary>

            <div class="food-items">
                {% for item in items %}
                <div class="food-item">
                    <form action="{% url 'edit_food' item.id %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="image-container" id="image-container-{{ item.id }}"
                            style="background-image: url('{{ item.imageOne.url }}');">
                            <input type="file" id="file-input-{{ item.id }}" name="imageOne" class="custom-file-input"
                                style="display: none;" onchange="updateImagePreview(event, '{{ item.id }}')">
                            <button type="button" class="change-image-button"
                                onclick="document.getElementById('file-input-{{ item.id }}').click();">Изменить</button>
                        </div>
                        <div class="container">
                            <div class="food-name">
                                <p>Название:</p>
                                <input name="food_name" type="text" value="{{ item.name }}">
                            </div>
                            <div class="food-description">
                                <p>Описание:</p>
                                <input name="description" type="text" value="{{ item.description }}">
                            </div>
                            <div class="food-price">
                                <p>Цена:</p>
                                <h3>{{ item.final_price  }}   /</h3>
                                <input type="number" name="price" value="{{ item.price }}" step="1">
                            </div>
                            <div class="food-status">
                                <p>Статус:</p>
                                <select name="food_status">
                                    <option value="True" {% if item.food_status == 'True' %}selected{% endif %}>В наличии
                                    </option>
                                    <option value="False" {% if item.food_status == 'False' %}selected{% endif %}>
                                        Отсутствует</option>
                                </select>
                            </div>
                            <div class="discount-container">
                                <p>Скидка:</p>
                                <input type="checkbox" name="discount_active" class="sale_checkbox" {% if item.discount_active %}checked{% endif %}>
                                <h4>%</h4>
                                <input type="number" name="discount_percent" class="sale_input" value="{{ item.discount_percent|default:0 }}" 
                                step="1" min="0" max="100">
                            </div>
                            <div class="food-quantity">
                                <p>Количество:</p>
                                <input type="number" name="quantity" class="quantity_input"
                                value="{{ item.quantity }}" min="0" step="1">
                            </div>

                            <button type="submit" class="action-btn" data-item="{{ item.id }}"
                                data-mode="delete">Удалить</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    </div>
</main>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    document.querySelectorAll("form").forEach(form => {
        const button = form.querySelector(".action-btn");

        // Все поля, которые должны триггерить "Сохранить"
        const fields = form.querySelectorAll(
            ".sale_checkbox, .sale_input, .quantity_input, input[name='food_name'], input[name='price'], select[name='food_status']"
        );

        // Сохраняем исходные значения
        const initial = {};
        fields.forEach(field => {
            if (field.type === "checkbox") {
                initial[field.name] = field.checked;
            } else {
                initial[field.name] = field.value;
            }
        });

        function updateButton() {
            let changed = false;

            fields.forEach(field => {
                if (field.type === "checkbox") {
                    if (initial[field.name] !== field.checked) changed = true;
                } else {
                    if (initial[field.name] !== field.value) changed = true;
                }
            });

            if (changed) {
                button.textContent = "Сохранить";
                button.dataset.mode = "save";
                button.style.backgroundColor = "#2fd419";
            } else {
                button.textContent = "Удалить";
                button.dataset.mode = "delete";
                button.style.backgroundColor = "#cc1616";
            }
        }

        fields.forEach(field => {
            field.addEventListener("input", updateButton);
            field.addEventListener("change", updateButton);
        });

        // Логика удаления
        form.addEventListener("submit", function (e) {
            if (button.dataset.mode === "delete") {
                e.preventDefault();
                if (confirm("Удалить этот товар?")) {
                    window.location.href = `/delete_food/${button.dataset.item}/`;
                }
            }
        });

    });

});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('.menu_search');
    const detailsList = document.querySelectorAll('.category-details');
    const foodItems = document.querySelectorAll('.food-item');

    // При фокусе открываем все категории
    searchInput.addEventListener('focus', () => {
        detailsList.forEach(d => d.open = true);
    });

    // Поиск при вводе
    searchInput.addEventListener('input', function () {
        const value = this.value.toLowerCase().trim();

        foodItems.forEach(item => {
            const name = item.querySelector('input[name="food_name"]').value.toLowerCase();

            if (name.includes(value)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });

        // Если поиск пустой — вернуть всё
        if (value === '') {
            foodItems.forEach(item => item.style.display = 'flex');
        }
    });
});
</script>

{% endblock %}