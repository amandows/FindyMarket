{% extends 'basis/basis_admin.html' %}

{% block link %}
<link rel="stylesheet" href="/static/css/edit_menu.css">
{% endblock %}

{% block main %}
<main>
    <h1 class="title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é</h1>
    <input type="search" class="menu_search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤">
    <div class="edit-menu">
        {% for category, items in categories %}
        <details class="category-details">
            <summary>{{ category }}</summary>

            <div class="food-items">
                {% for item in items %}
                <div class="food-item">
                    <form action="{% url 'edit_food' item.id %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="image-container" id="image-container-{{ item.id }}"
                            style="background-image: url('{{ item.imageOne.url }}');">
                            <input type="file" id="file-input-{{ item.id }}" name="imageOne" class="custom-file-input"
                                style="display: none;" onchange="updateImagePreview(event, '{{ item.id }}')">
                            <button type="button" class="change-image-button"
                                onclick="document.getElementById('file-input-{{ item.id }}').click();">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div class="container">
                            <div class="food-name">
                                <p>–ù–∞–∑–≤–∞–Ω–∏–µ:</p>
                                <input name="food_name" type="text" value="{{ item.name }}">
                            </div>
                            <div class="food-description">
                                <p>–û–ø–∏—Å–∞–Ω–∏–µ:</p>
                                <input name="description" type="text" value="{{ item.description }}">
                            </div>
                            <div class="food-price">
                                <p>–¶–µ–Ω–∞:</p>
                                <h3>{{ item.final_price  }}   /</h3>
                                <input type="number" name="price" value="{{ item.price }}" step="1">
                            </div>
                            <div class="food-status">
                                <p>–°—Ç–∞—Ç—É—Å:</p>
                                <select name="food_status">
                                    <option value="True" {% if item.food_status == 'True' %}selected{% endif %}>–í –Ω–∞–ª–∏—á–∏–∏
                                    </option>
                                    <option value="False" {% if item.food_status == 'False' %}selected{% endif %}>
                                        –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                                </select>
                            </div>
                            <div class="discount-container">
                                <p>–°–∫–∏–¥–∫–∞:</p>
                                <input type="checkbox" name="discount_active" class="sale_checkbox" {% if item.discount_active %}checked{% endif %}>
                                <h4>%</h4>
                                <input type="number" name="discount_percent" class="sale_input" value="{{ item.discount_percent|default:0 }}" 
                                step="1" min="0" max="100">
                            </div>
                            <button type="submit" class="action-btn" data-item="{{ item.id }}"
                                data-mode="delete">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    </div>
</main>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    function markAsChanged(form) {
        const button = form.querySelector(".action-btn");
        button.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
        button.dataset.mode = "save";
        button.style.backgroundColor = "#2fd419";
    }

    function resetToDelete(form) {
        const button = form.querySelector(".action-btn");
        button.textContent = "–£–¥–∞–ª–∏—Ç—å";
        button.dataset.mode = "delete";
        button.style.backgroundColor = "#cc1616";
    }

    document.querySelectorAll(".food-item form").forEach(form => {

        const button = form.querySelector(".action-btn");

        const inputs = form.querySelectorAll(
            "input[name='food_name'], input[name='description'], input[name='price'], select[name='food_status']"
        );

        const fileInput = form.querySelector("input[type='file']");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const initialValues = {};
        inputs.forEach(input => {
            initialValues[input.name] = input.value;
        });

        function checkChanges() {
            let changed = false;

            inputs.forEach(input => {
                if (input.value !== initialValues[input.name]) {
                    changed = true;
                }
            });

            if (changed) {
                markAsChanged(form);
            } else {
                resetToDelete(form);
            }
        }

        // –°–ª—É—à–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
        inputs.forEach(input => {
            input.addEventListener("input", checkChanges);
            input.addEventListener("change", checkChanges);
        });

        // üî• –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        if (fileInput) {
            fileInput.addEventListener("change", function () {
                markAsChanged(form);
            });
        }

        // –õ–æ–≥–∏–∫–∞ submit
        form.addEventListener("submit", function (e) {
            if (button.dataset.mode === "delete") {
                e.preventDefault();
                if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) {
                    window.location.href = `/delete_food/${button.dataset.item}/`;
                }
            }
        });

    });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".discount-container").forEach(container => {
        const form = container.closest("form");
        const button = form.querySelector(".action-btn");

        const checkbox = container.querySelector(".sale_checkbox");
        const input = container.querySelector(".sale_input");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const initial = {
            checked: checkbox.checked,
            percent: input.value
        };

        function updateButton() {
            const changed = checkbox.checked !== initial.checked || input.value !== initial.percent;
            if (changed) {
                button.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
                button.dataset.mode = "save";
                button.style.backgroundColor = "#2fd419";
            } else {
                button.textContent = "–£–¥–∞–ª–∏—Ç—å";
                button.dataset.mode = "delete";
                button.style.backgroundColor = "#cc1616";
            }
        }

        checkbox.addEventListener("change", updateButton);
        input.addEventListener("input", updateButton);
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('.menu_search');
    const detailsList = document.querySelectorAll('.category-details');
    const foodItems = document.querySelectorAll('.food-item');

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    searchInput.addEventListener('focus', () => {
        detailsList.forEach(d => d.open = true);
    });

    // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
    searchInput.addEventListener('input', function () {
        const value = this.value.toLowerCase().trim();

        foodItems.forEach(item => {
            const name = item.querySelector('input[name="food_name"]').value.toLowerCase();

            if (name.includes(value)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });

        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
        if (value === '') {
            foodItems.forEach(item => item.style.display = 'flex');
        }
    });
});
</script>

{% endblock %}