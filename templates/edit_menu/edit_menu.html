{% extends 'basis/basis_admin.html' %}

{% block link %}
<link rel="stylesheet" href="/static/css/edit_menu.css">
{% endblock %}

{% block main %}
<main>
    <div id="globalLoader" class="global-loader">
        <div class="loader-spinner"></div>
        <p>–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...</p>
    </div>
    <h1 class="title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é</h1>
    <div class="menu_search_container">
        <input type="search" class="menu_search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤">
        <button class="full_save" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
    </div>
    <div class="edit-menu">
        {% for category, items in categories %}
        <details class="category-details">
            <summary>{{ category }}</summary>

            <div class="food-items">
                {% for item in items %}
                <div class="food-item">
                    <form action="{% url 'edit_food' item.id %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="image-container" id="image-container-{{ item.id }}"
                            style="background-image: url('{{ item.imageOne.url }}');">
                            <input type="file" id="file-input-{{ item.id }}" name="imageOne" class="custom-file-input"
                                style="display: none;" onchange="updateImagePreview(event, '{{ item.id }}')">
                            <button type="button" class="change-image-button"
                                onclick="document.getElementById('file-input-{{ item.id }}').click();">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        </div>
                        <div class="container">
                            <div class="food-name">
                                <p>–ù–∞–∑–≤–∞–Ω–∏–µ:</p>
                                <input name="food_name" type="text" value="{{ item.name }}">
                            </div>
                            <div class="food-description">
                                <p>–û–ø–∏—Å–∞–Ω–∏–µ:</p>
                                <input name="description" type="text" value="{{ item.description }}">
                            </div>
                            <div class="food-price">
                                <p>–¶–µ–Ω–∞:</p>
                                <h3>{{ item.final_price  }}   /</h3>
                                <input type="number" name="price" value="{{ item.price }}" step="1">
                            </div>
                            <div class="food-status">
                                <p>–°—Ç–∞—Ç—É—Å:</p>
                                <select name="food_status">
                                    <option value="True" {% if item.food_status == 'True' %}selected{% endif %}>–í –Ω–∞–ª–∏—á–∏–∏
                                    </option>
                                    <option value="False" {% if item.food_status == 'False' %}selected{% endif %}>
                                        –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</option>
                                </select>
                            </div>
                            <div class="discount-container">
                                <p>–°–∫–∏–¥–∫–∞:</p>
                                <input type="checkbox" name="discount_active" class="sale_checkbox" {% if item.discount_active %}checked{% endif %}>
                                <h4>%</h4>
                                <input type="number" name="discount_percent" class="sale_input" value="{{ item.discount_percent|default:0 }}" 
                                step="1" min="0" max="100">
                            </div>
                            <div class="food-quantity">
                                <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</p>
                                <input type="number" name="quantity" class="quantity_input"
                                value="{{ item.quantity }}" min="0" step="1">
                            </div>

                            <button type="submit" class="action-btn" data-item="{{ item.id }}"
                                data-mode="delete">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endfor %}
    </div>
</main>
{% endblock %}

{% block script %}
<script>
    function showLoader(text = "–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...") {
    const loader = document.getElementById("globalLoader");
    loader.querySelector("p").textContent = text;
    loader.classList.add("active");
}

function hideLoader() {
    document.getElementById("globalLoader").classList.remove("active");
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const fullSaveBtn = document.querySelector(".full_save");
    const changedForms = new Set();

    document.querySelectorAll(".food-item form").forEach(form => {
        const button = form.querySelector(".action-btn");

        const fields = form.querySelectorAll(
            ".sale_checkbox, .sale_input, .quantity_input, input[name='food_name'], input[name='price'], select[name='food_status'], input[name='description'], input[type='file']"
        );

        const initial = {};
        fields.forEach(field => {
            if (field.type === "checkbox") {
                initial[field.name] = field.checked;
            } else {
                initial[field.name] = field.value;
            }
        });

        function checkChanges() {
            let changed = false;

            fields.forEach(field => {
                if (field.type === "checkbox") {
                    if (initial[field.name] !== field.checked) changed = true;
                } else if (field.type === "file") {
                    if (field.files.length > 0) changed = true;
                } else {
                    if (initial[field.name] !== field.value) changed = true;
                }
            });

            if (changed) {
                button.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
                button.dataset.mode = "save";
                button.style.backgroundColor = "#2fd419";
                changedForms.add(form);
            } else {
                button.textContent = "–£–¥–∞–ª–∏—Ç—å";
                button.dataset.mode = "delete";
                button.style.backgroundColor = "#cc1616";
                changedForms.delete(form);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–æ 2+
            if (changedForms.size >= 2) {
                fullSaveBtn.style.display = "block";
            } else {
                fullSaveBtn.style.display = "none";
            }
        }

        fields.forEach(field => {
            field.addEventListener("input", checkChanges);
            field.addEventListener("change", checkChanges);
        });

        // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–∫ —É —Ç–µ–±—è
        form.addEventListener("submit", function (e) {
            if (button.dataset.mode === "delete") {
                e.preventDefault();
                if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?")) {
                    window.location.href = `/delete_food/${button.dataset.item}/`;
                }
            }
        });
    });

    // üî• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    fullSaveBtn.addEventListener("click", async function () {

    showLoader("–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã...");

    fullSaveBtn.disabled = true;

    const promises = [];

    changedForms.forEach(form => {
        const formData = new FormData(form);

        promises.push(
            fetch(form.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
        );
    });

    await Promise.all(promises);

    showLoader("–ì–æ—Ç–æ–≤–æ! –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...");

    setTimeout(() => {
        location.reload();
    }, 700);
});



});

</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.querySelector('.menu_search');
    const detailsList = document.querySelectorAll('.category-details');
    const foodItems = document.querySelectorAll('.food-item');

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    searchInput.addEventListener('focus', () => {
        detailsList.forEach(d => d.open = true);
    });

    // –ü–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
    searchInput.addEventListener('input', function () {
        const value = this.value.toLowerCase().trim();

        foodItems.forEach(item => {
            const name = item.querySelector('input[name="food_name"]').value.toLowerCase();

            if (name.includes(value)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });

        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë
        if (value === '') {
            foodItems.forEach(item => item.style.display = 'flex');
        }
    });
});
</script>

{% endblock %}