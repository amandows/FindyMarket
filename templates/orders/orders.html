{% extends 'basis/basis_admin.html' %}

{% block link %}
<link rel="stylesheet" href="/static/css/orders.css">
{% endblock %}

{% block main %}
<main>
    <h1 class="title">–ó–∞–∫–∞–∑—ã</h1>
    <input type="search" id="order-search" class="order-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤">
    <div class="orders-btn">
        <button class="new-orders" onclick="showOrders('tbody', this)">–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã <span
                class="inProgressStatus"></span></button>
        <button class="completed-orders" onclick="showOrders('tbody-completed', this)">–£—Å–ø–µ—à–Ω—ã–µ –∑–∞–∫–∞–∑—ã</button>
        <button class="cancelled-orders" onclick="showOrders('tbody-cancelled', this)">–û—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã</button>
    </div>
    <table class="order-table">
        <thead>
            <tr class="nav-bar">
                <th class="order_number">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</th>
                <th class="created_at">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</th>
                <th class="order_details">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞, –¥–∞—Ç–∞</th>
                <th class="total_amount">–û–±—â–∞—è —Å—É–º–º–∞</th>
                <th class="payment_status">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</th>
                <th class="status">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</th>
            </tr>
        </thead>
        <tbody id="tbody">
        </tbody>

        <tbody id="tbody-completed" style="display: none;">
            {% for order in orders %}
            {% if order.status == 'completed' %}
            <tr class="order">
                <td class="order-number-container">
                    <p class="order-number">{{order.order_number}}</p>
                </td>
                <td class="created-at-container">
                    <p class="user-name"><span>–ò–º—è:</span> {{order.order_user_name}}</p>
                    <p class="tel-number"><span>–¢–µ–ª:</span> {{order.order_tel_number}}</p>
                    <p class="adress"><span>–ê–¥—Ä–µ—Å:</span> {{order.order_adsress}}</p>
                </td>
                <td class="order-details-container">
                    <ol id="myList-{{order.id}}" class="order-details-list">
                        {% for line in order.order_details.splitlines %}
                        <li>{{ line }}</li>
                        {% endfor %}
                    </ol>
                    <p class="created-at">–î–∞—Ç–∞: {{order.created_at}}</p>
                </td>
                <td class="total-amount-container">
                    <p class="total-amount">{{order.total_amount}} —Å–æ–º</p>
                </td>
                <td class="payment">
                    {% if order.order_payment_status == '–û–Ω–ª–∞–π–Ω' %}
                    <div class="payment-online">
                        <p>–û–ø–ª–∞—á–µ–Ω–æ –æ–Ω–ª–∞–π–Ω</p>
                        <button onclick="viewReceipt('{{order.order_bank_check}}')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ–∫</button>`
                    </div>
                    {% else %}
                    <p>–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ</p>
                    {% endif %}
                </td>
                <td class="order-status">
                    <p class="order-completed">–£—Å–ø–µ—à–Ω–æ</p>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>


        <tbody id="tbody-cancelled" style="display: none;">
            {% for order in orders %}
            {% if order.status == 'cancelled' %}
            <tr class="order">
                <td class="order-number-container">
                    <p class="order-number">{{order.order_number}}</p>
                </td>
                <td class="created-at-container">
                    <p class="user-name"><span>–ò–º—è:</span> {{order.order_user_name}}</p>
                    <p class="tel-number"><span>–¢–µ–ª:</span> {{order.order_tel_number}}</p>
                    <p class="adress"><span>–ê–¥—Ä–µ—Å:</span> {{order.order_adsress}}</p>
                </td>
                <td class="order-details-container">
                    <ol id="myList-{{order.id}}" class="order-details-list">
                        {% for line in order.order_details.splitlines %}
                        <li>{{ line }}</li>
                        {% endfor %}
                    </ol>
                    <p class="created-at">–î–∞—Ç–∞: {{order.created_at}}</p>
                </td>
                <td class="total-amount-container">
                    <p class="total-amount">{{order.total_amount}} —Å–æ–º</p>
                </td>
                <td class="payment">
                    {% if order.order_payment_status == '–û–Ω–ª–∞–π–Ω' %}
                    <div class="payment-online">
                        <p>–û–ø–ª–∞—á–µ–Ω–æ –æ–Ω–ª–∞–π–Ω</p>
                        <button onclick="viewReceipt('{{order.order_bank_check}}')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ–∫</button>`
                    </div>
                    {% else %}
                    <p>–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∞–≤–∫–µ</p>
                    {% endif %}
                </td>
                <td class="order-status">
                    <p class="order-cancelled">–ù–µ—É–¥–∞—á–Ω–æ</p>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>

    </table>
    <div class="table-pagination" data-target="tbody-completed"></div>
    <div class="table-pagination" data-target="tbody-cancelled"></div>


    <events name="ondownevent" ondown="playbackgroundsound()" />
    <button id="enable-sound" style="display:none;">Enable Sound</button>
    <audio id="notification-sound" src="/static/media/notification.mp3" preload="auto"></audio>
</main>
{% endblock %}

{% block script %}

<script src="/static/script/jquery-3.7.1.js"></script>
<script src="/static/script/async.js"></script>
<script src="/static/script/orders-btn.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        function paginateTable(tbodyId, rowsPerPage = 50) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;

            const rows = Array.from(tbody.querySelectorAll("tr.order"));
            const totalPages = Math.ceil(rows.length / rowsPerPage);

            const pagination = document.querySelector(`.table-pagination[data-target="${tbodyId}"]`);
            if (!pagination) return;

            function showPage(page) {
                rows.forEach((row, index) => {
                    row.style.display =
                        (index >= (page - 1) * rowsPerPage &&
                            index < page * rowsPerPage)
                            ? "table-row"
                            : "none";
                });

                pagination.querySelectorAll("button").forEach(btn => {
                    btn.classList.remove("active");
                });

                pagination.querySelector(`button[data-page="${page}"]`).classList.add("active");

                // üî• –°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö –∫ —Ç–∞–±–ª–∏—Ü–µ
                tbody.scrollIntoView({ behavior: "smooth", block: "start" });
            }

            // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.dataset.page = i;
                btn.onclick = () => showPage(i);
                pagination.appendChild(btn);
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (totalPages > 0) {
                showPage(1);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –¥–≤—É—Ö —Ç–∞–±–ª–∏—Ü
        paginateTable("tbody-completed", 50);
        paginateTable("tbody-cancelled", 50);

    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('order-search');
    const orders = document.querySelectorAll('tr.order');

    searchInput.addEventListener('input', function () {
        const value = this.value.toLowerCase().trim();

        orders.forEach(order => {
            const orderNumber = order.querySelector('.order-number')?.innerText.toLowerCase() || '';
            const userName = order.querySelector('.user-name')?.innerText.toLowerCase() || '';
            const tel = order.querySelector('.tel-number')?.innerText.toLowerCase() || '';

            if (
                orderNumber.includes(value) ||
                userName.includes(value) ||
                tel.includes(value)
            ) {
                order.style.display = '';
            } else {
                order.style.display = 'none';
            }
        });
    });
});
</script>

{% endblock %}